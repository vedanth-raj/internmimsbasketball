<!DOCTYPE html>
<html>
<head>
    <title>Timer Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #333; color: white; }
        .timer-display { font-size: 48px; font-family: 'Courier New', monospace; margin: 20px 0; }
        button { padding: 15px 30px; margin: 10px; font-size: 16px; }
        .log { background: #222; padding: 10px; border-radius: 5px; height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üïê Timer Debug Console</h1>
    
    <div class="timer-display" id="timer-display">12:00</div>
    
    <div>
        <button onclick="testStartTimer()">Start Timer</button>
        <button onclick="testPauseTimer()">Pause Timer</button>
        <button onclick="testResetTimer()">Reset Timer</button>
        <button onclick="testSetTimer()">Set 5:30</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <h2>Debug Log</h2>
    <div class="log" id="debug-log"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getDatabase, ref, set, update, onValue } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAWCSuJ4CFUy_mIiVJSECc8hGZok3yfWnY",
            authDomain: "internmimsbasketball.firebaseapp.com",
            databaseURL: "https://internmimsbasketball-default-rtdb.firebaseio.com",
            projectId: "internmimsbasketball",
            storageBucket: "internmimsbasketball.firebasestorage.app",
            messagingSenderId: "97822648007",
            appId: "1:97822648007:web:cfc93e3a6fb8233c6c40e2",
            measurementId: "G-KM2NGQ30TJ"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let currentTimer = '12:00';
        let isRunning = false;
        let timerInterval = null;
        
        function log(message) {
            const logDiv = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateDisplay() {
            document.getElementById('timer-display').textContent = currentTimer;
        }
        
        // Listen to Firebase changes
        const matchRef = ref(database, 'matches/current');
        onValue(matchRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (data.timer !== currentTimer) {
                    currentTimer = data.timer || '12:00';
                    updateDisplay();
                    log(`Firebase timer updated: ${currentTimer}`);
                }
                
                if (data.isRunning !== isRunning) {
                    isRunning = data.isRunning || false;
                    log(`Firebase running state: ${isRunning}`);
                    
                    if (isRunning && !timerInterval) {
                        startLocalTimer();
                    } else if (!isRunning && timerInterval) {
                        stopLocalTimer();
                    }
                }
            }
        });
        
        function startLocalTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!isRunning) return;
                
                const [minutes, seconds] = currentTimer.split(':').map(Number);
                let totalSeconds = minutes * 60 + seconds;
                
                if (totalSeconds > 0) {
                    totalSeconds--;
                    const newMinutes = Math.floor(totalSeconds / 60);
                    const newSeconds = totalSeconds % 60;
                    currentTimer = `${newMinutes.toString().padStart(2, '0')}:${newSeconds.toString().padStart(2, '0')}`;
                    
                    updateDisplay();
                    
                    // Update Firebase
                    update(ref(database), {
                        'matches/current/timer': currentTimer,
                        'matches/current/lastUpdated': Date.now()
                    }).catch(err => log(`Firebase update error: ${err.message}`));
                    
                    if (totalSeconds === 0) {
                        log('Time is up!');
                        testPauseTimer();
                    }
                } else {
                    log('Timer at zero, stopping');
                    testPauseTimer();
                }
            }, 1000);
            
            log('Local timer started');
        }
        
        function stopLocalTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                log('Local timer stopped');
            }
        }
        
        // Test functions
        window.testStartTimer = async () => {
            try {
                log('Starting timer...');
                await update(ref(database), {
                    'matches/current/isRunning': true,
                    'matches/current/lastUpdated': Date.now()
                });
                log('Timer start command sent to Firebase');
            } catch (error) {
                log(`Error starting timer: ${error.message}`);
            }
        };
        
        window.testPauseTimer = async () => {
            try {
                log('Pausing timer...');
                await update(ref(database), {
                    'matches/current/isRunning': false,
                    'matches/current/lastUpdated': Date.now()
                });
                log('Timer pause command sent to Firebase');
            } catch (error) {
                log(`Error pausing timer: ${error.message}`);
            }
        };
        
        window.testResetTimer = async () => {
            try {
                log('Resetting timer...');
                await update(ref(database), {
                    'matches/current/timer': '12:00',
                    'matches/current/isRunning': false,
                    'matches/current/lastUpdated': Date.now()
                });
                log('Timer reset command sent to Firebase');
            } catch (error) {
                log(`Error resetting timer: ${error.message}`);
            }
        };
        
        window.testSetTimer = async () => {
            try {
                log('Setting timer to 5:30...');
                await update(ref(database), {
                    'matches/current/timer': '05:30',
                    'matches/current/isRunning': false,
                    'matches/current/lastUpdated': Date.now()
                });
                log('Timer set command sent to Firebase');
            } catch (error) {
                log(`Error setting timer: ${error.message}`);
            }
        };
        
        window.clearLog = () => {
            document.getElementById('debug-log').innerHTML = '';
        };
        
        // Initialize
        log('Timer debug console loaded');
        updateDisplay();
        
        // Initialize match if it doesn't exist
        setTimeout(async () => {
            try {
                await set(ref(database, 'matches/current'), {
                    teamA: 'Team A',
                    teamB: 'Team B',
                    scoreA: 0,
                    scoreB: 0,
                    timer: '12:00',
                    isRunning: false,
                    quarter: 1,
                    players: {},
                    lastUpdated: Date.now()
                });
                log('Match initialized');
            } catch (error) {
                log(`Match initialization error: ${error.message}`);
            }
        }, 1000);
    </script>
</body>
</html>